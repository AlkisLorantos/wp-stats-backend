generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum EventType {
  GOAL
  SHOT
  ASSIST
  STEAL
  TURNOVER
  BLOCK
  EXCLUSION
  PENALTY_SHOT
}

enum GameSituation {
  SIX_ON_SIX
  MAN_UP
  MAN_DOWN
  COUNTER
  PENALTY
}

enum ShotOutcome {
  GOAL
  SAVED
  MISSED
  BLOCKED
  POST
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  role      String   @default("coach")
  apiKey    String?
  teamId    Int
  team      Team     @relation(fields: [teamId], references: [id])
  createdAt DateTime @default(now())
}

model Team {
  id       Int      @id @default(autoincrement())
  name     String   @unique
  users    User[]
  players  Player[]
  games    Game[]

  RosterPreset RosterPreset[]
}

model Player {
  id         Int      @id @default(autoincrement())
  firstName  String
  lastName   String
  name       String   @unique
  birthday   DateTime?
  position   String?
  capNumber  Int?
  teamId     Int
  team       Team     @relation(fields: [teamId], references: [id])
  stats      StatEvent[]

  GameRoster GameRoster[]

  RosterPresetPlayer RosterPresetPlayer[]

  Substitution Substitution[] @relation("PlayerIn")

  substitutionsOut Substitution[] @relation("PlayerOut")

  StartingLineup StartingLineup[]
}

enum GameStatus {
  UPCOMING
  LIVE
  ENDED
}

model Game {
  id            Int      @id @default(autoincrement())
  date          DateTime
  opponent      String
  location      String?
  homeOrAway   String?  

  status        GameStatus @default(UPCOMING)
  teamScore     Int      @default(0)
  opponentScore Int      @default(0)
  teamId        Int
  team          Team     @relation(fields: [teamId], references: [id])
  stats         StatEvent[]
  period        Int      @default(1)

  GameRoster GameRoster[]

  Substitution Substitution[]

  StartingLineup StartingLineup[]
}

model StatEvent {
  id            Int       @id @default(autoincrement())
  timestamp     DateTime  @default(now())
  type          EventType
  context       GameSituation?
  shotOutcome   ShotOutcome?
  period        Int?
  clock         Float?
  x             Float?
  y             Float?
  capNumber     Int?
  playerId      Int
  gameId        Int

  player        Player    @relation(fields: [playerId], references: [id])
  game          Game      @relation(fields: [gameId], references: [id])

  // Link goal to assist
  assistEventId Int?      @unique
  assistEvent   StatEvent? @relation("GoalAssist", fields: [assistEventId], references: [id])
  goalEvent     StatEvent? @relation("GoalAssist")
}

model GameRoster {
  id        Int      @id @default(autoincrement())
  capNumber Int
  playerId  Int
  gameId    Int

  player    Player   @relation(fields: [playerId], references: [id])
  game      Game     @relation(fields: [gameId], references: [id])

  @@unique([gameId, capNumber])
  @@unique([gameId, playerId])
}

model RosterPreset {
  id        Int             @id @default(autoincrement())
  name      String
  teamId    Int
  team      Team            @relation(fields: [teamId], references: [id])
  players   RosterPresetPlayer[]

  createdAt DateTime @default(now())
}

model RosterPresetPlayer {
  id        Int  @id @default(autoincrement())
  presetId  Int
  playerId  Int
  capNumber Int

  preset    RosterPreset @relation(fields: [presetId], references: [id])
  player    Player       @relation(fields: [playerId], references: [id])

  @@unique([presetId, capNumber])
}

model Substitution {
  id         Int      @id @default(autoincrement())
  gameId     Int
  period     Int
  time       Float    
  playerInId Int
  playerOutId Int
  teamId     Int

  game       Game     @relation(fields: [gameId], references: [id])
  playerIn   Player   @relation("PlayerIn", fields: [playerInId], references: [id])
  playerOut  Player   @relation("PlayerOut", fields: [playerOutId], references: [id])
}

model StartingLineup {
  id        Int      @id @default(autoincrement())
  gameId    Int
  period    Int
  playerId  Int

  game      Game    @relation(fields: [gameId], references: [id])
  player    Player   @relation(fields: [playerId], references: [id])
}